---
title:  パフォーマンスチューニング
---

> このページは先行公開版です。内容は今後予告なく更新される可能性があります。

## Helm チャートの値を表示

```bash
helm show values dify/dify
```

---

## 1. リソース割り当ての改善

* `api`、`worker`、`plugin_daemon` サービスのリソース割り当てを調整することで、Dify のパフォーマンスを向上させることができます。
* 使用している環境やリソース状況に応じて、以下のように値を増やしてください。

```yaml
api:
  replicas: 3
  serverWorkerAmount: 1
  resources:
    limits:
      cpu: 3000m
      memory: 10240Mi
    requests:
      cpu: 1500m
      memory: 5120Mi
worker:
  replicas: 3
  celeryWorkerAmount: 1
  resources:
    limits:
      cpu: 2000m
      memory: 10240Mi
    requests:
      cpu: 1000m
      memory: 5120Mi
plugin_daemon:
  replicas: 3
  resources:
    limits:
      cpu: 1000m
      memory: 3072Mi
    requests:
      cpu: 500m
      memory: 1536Mi
```

---

## 2. 外部 PostgreSQL のパフォーマンス向上

* 外部の PostgreSQL データベースを使用している場合、`postgresql.conf` ファイル内の以下のパラメータを調整することでパフォーマンスが改善されることがあります：

  * `max_connections`：使用環境に応じて `2000` 以上に設定することを推奨します。

---

## 3. `api` および `worker` サービスのワーカー数の調整

* 環境やリソース状況に応じて、各サービスのワーカー数を設定できます：

```yaml
api:
  serverWorkerAmount: 1
worker:
  celeryWorkerAmount: 1
```

* `celeryWorkerAmount`: `worker` サービスで使用される **Celery ワーカーの数**

  * 設定方法の目安：

    * **本番環境**では、**CPU コア数と同じ値**を推奨
    * **テスト環境**では、**1** に設定してリソースを節約可能
  * [参考: Celery CLI ドキュメント](https://docs.celeryq.dev/en/stable/reference/cli.html#cmdoption-celery-worker-c)

* `serverWorkerAmount`: `api` サービスで使用される **Gunicorn ワーカーの数** <Warning>
  通常は `1` に設定することを推奨します。
  `1` を超える値を設定する場合は、API サービスが高負荷に耐えられるように構成を確認してください。 </Warning>

  * 計算式の目安：

    * `CPU コア数 × 2 + 1`
  * [参考: Gunicorn ドキュメント](https://docs.gunicorn.org/en/stable/design.html#how-many-workers)
